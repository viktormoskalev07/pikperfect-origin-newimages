(function(f){f.i18n={dict:null,setDictionary:function(a){this.dict=a},_:function(a,b){var c=a;if(this.dict&&this.dict[a])c=this.dict[a];return this.printf(c,b)},toEntity:function(a){for(var b="",c=0;c<a.length;c++)b+=a.charCodeAt(c)>128?"&#"+a.charCodeAt(c)+";":a.charAt(c);return b},stripStr:function(a){return a.replace(/^\s*/,"").replace(/\s*$/,"")},stripStrML:function(a){a=a.split("\n");for(var b=0;b<a.length;b++)a[b]=stripStr(a[b]);return stripStr(a.join(" "))},printf:function(a,b){if(!b)return a;for(var c="",e=a.split("%s"),d=0;d<b.length;d++){if(e[d].lastIndexOf("%")==e[d].length-1&&d!=b.length-1)e[d]+="s"+e.splice(d+1,1)[0];c+=e[d]+b[d]}return c+e[e.length-1]}}})(jQuery);
var config=document.view.flipbook.configuration,lang=config.language,imgWidth=config.imgWidth,imgHeight=config.imgHeight,windowWidth,windowHeight;var PikBookletFullscreen={};(function($){PikBookletFullscreen.computeSizes=function(){windowWidth=window.innerWidth;if(windowWidth>1600){windowWidth=1600;}
var heightSpace=$('.wrapper .header').outerHeight()+$('.wrapper .version').outerHeight();windowHeight=window.innerHeight;if($('body').hasClass('share')){heightSpace+=$('.wrapper header').outerHeight()+20;}
var ratioHeight=windowHeight/imgHeight;imgHeight=windowHeight;imgWidth=imgWidth*ratioHeight;if((imgWidth*2)>windowWidth){var newWidth=windowWidth/2,newRatioWidth=newWidth/imgWidth;imgWidth=newWidth;imgHeight*=newRatioWidth;}
if(imgHeight>(windowHeight-heightSpace)){var newHeight=windowHeight-heightSpace,newRatioHeight=newHeight/imgHeight;imgHeight=newHeight;if(config.imgWidth==config.imgHeight){imgWidth=imgHeight;}else{imgWidth*=newRatioHeight;}}
var myBookHidden=$('#mybook.hidden');if(myBookHidden.length&&myBookHidden.height()<imgHeight){myBookHidden.height(imgHeight).removeClass('hidden');}};})(jQuery);if(config.fullscreen==1){PikBookletFullscreen.computeSizes();}
var $mybook;$(function(){$mybook=$('#mybook');var mybookMargin=windowHeight-$('.header').height()-$mybook.height()-$('.version').height();if($('body').hasClass('share')){mybookMargin-=$('.wrapper header').height();}
if(mybookMargin){$mybook.css('margin-top',parseInt(mybookMargin/2));$mybook.css('margin-bottom',parseInt(mybookMargin/2));}
var options={opacity:0.80},$loading=$('#loading'),$slider=$("#flip-control-slider"),$mybook_images=$mybook.find('img'),loaded=1,$book_api,$total;function startBooklet(){$('.not-loaded').removeClass('not-loaded');if(config.fullscreen==1){PikBookletFullscreen.computeSizes();}
$mybook.booklet({width:imgWidth*2,height:imgHeight,pagePadding:0,pageNumbers:false,next:'.right-paginator',prev:'.left-paginator',hash:true,create:function(){$('.ui-slider-handle.hide').removeClass('hide');},start:function(event,data){updateDisplay(data.index,$mybook.find('.b-page').length);$slider.slider("value",[data.index]);}});if(mybookMargin){$mybook.css('margin-top',parseInt(mybookMargin/2));$mybook.css('margin-bottom',parseInt(mybookMargin/2));}
$book_api=$mybook.data("booklet");$total=$mybook.find('.b-page').length;var currentIndex=$mybook.find('.b-page.b-p1').index();$('#flip-start').click(function(e){e.preventDefault();$book_api.gotopage(0);}).attr('title',$.i18n._('FIRST_PAGE'));$('#flip-end').click(function(e){e.preventDefault();$book_api.gotopage($total-2);}).attr('title',$.i18n._('LAST_PAGE'));$slider.slider({value:0,min:0,max:$total-2,step:2,slide:function(event,ui){updateDisplay(ui.value,$total);},stop:function(event,ui){$book_api.gotopage(ui.value);}});updateDisplay(currentIndex,$total);$slider.slider("value",[currentIndex]);$('body').trigger('bookletLoaded');$('.pik-review-background').css({'opacity':options.opacity,'filter':'progid:DXImageTransform.Microsoft.Alpha(opacity='+(100*options.opacity)+')'});$('.b-page-blank').addClass('pik-blank-page').html('<div class="blank-page-text">'+
($('.not-for-print').length?$('.not-for-print').html():'')+'</div>');$('input[name="end_paper"]').trigger('change');if($('.pik-blank-page').hasClass('pik-blank-page-white')){$('.b-page-blank.pik-blank-page').addClass('pik-blank-page-white');}}
function loadImage(image){var $img=$(image),source;if($img.attr('presrc')){source=$img.attr('presrc');}
else{source=$img.attr('src');}
$('<img/>').load(function(){if($img.attr('presrc')){$img.attr('src',source);}
++loaded;if(2==loaded){$loading.hide();startBooklet();}
loadNextImage();}).attr('src',source);}
function loadNextImage(){var image=$mybook_images[loaded-1];loadImage(image);}
function startReviewNotFound(){setTimeout(function(){if(loaded==1){$('#loading').hide();$('#notFound').show();}},10000);}
$(window).load(function(){loadNextImage();startReviewNotFound();});$('.pik-page a.page-image').on('click',function(e){e.preventDefault();});function updateDisplay(index,total){var x=config.isPremium?index-3:index-2;var y=config.isPremium?index-2:index-1;var txt=x+" - "+y;if(index==0){txt=$.i18n._('COVERS');}else if((index==2)&&!config.isPremium){txt=index-1;}else if((index==total-2)&&!config.isPremium){txt=index-2;}else if(((index==2)||(index==total-2))&&config.isPremium){txt=$.i18n._('END_PAPER');}
$slider.find('a').text(txt);}});window.addEventListener("orientationchange",function(){location.reload();});
var ratioX=1,ratioY=1;(function($){jQuery.fn.focusAtEnd=function(){return this.each(function(){$(this).focus();if(this.setSelectionRange){var len=$(this).val().length*2;this.setSelectionRange(len,len);}else{$(this).val($(this).val());}
this.scrollTop=999999;});};})(jQuery);var PikErrors=(function(){function log(message,file,line){$.post('/logger.php',{file:file,message:message,line:line,review:true,jobId:document.view.flipbook.configuration.jobId});}
window.onerror=function(message,file,line){log(message,file,line);};return{log:log};})();$(function(){var configuration=document.view.flipbook.configuration,selectedDefault=configuration.selectedDefault,costEstimateUrl=configuration.costEstimateUrl,jobNumber=configuration.jobNumber,isPremium=configuration.isPremium,premiumFormatId=configuration.premiumFormatId,premiumCoverTypeId=configuration.premiumCoverTypeId,premiumQualityId=configuration.premiumQualityId,premiumPaddedCover=configuration.premiumPaddedCover,premiumPresentationBox=configuration.premiumPresentationBox,numberOfPages=parseInt(configuration.numberOfPages),largeLayFlatMaxPages=parseInt(configuration.largeLayFlatMaxPages),layFlatMaxPages=parseInt(configuration.layFlatMaxPages);if(config.fullscreen){ratioX=imgWidth/config.imgWidth;ratioY=imgHeight/config.imgHeight;$('.pik-review').each(function(){var top=parseInt($(this).css('top').replace('px')),left=parseInt($(this).css('left').replace('px'));top=top?top*ratioX:0;left=left?left*ratioY:0;$(this).css('top',top);$(this).css('left',left);});}
if(configuration.adminFlipbook){return;}
var formats={1:{id:1,paper:[2,3]},2:{id:2,paper:[2,3]},3:{id:3,paper:[1,2]},4:{id:4,paper:[1,2]},5:{id:5,paper:[1,2]},8:{id:8,paper:[6,7]},9:{id:9,paper:[6,7]},10:{id:10,paper:[6,7]},11:{id:11,paper:[6,7]}};if(numberOfPages<=largeLayFlatMaxPages){formats[1].paper.push(5);}
if(numberOfPages<=layFlatMaxPages){([2,3,4,5]).forEach(function(index){formats[index].paper.push(5);});}
function checkDifferences(force){if(configuration.isUnbranded||isPremium){return;}
var showPopup=false;if($(window).scrollTop()==0||force===true){var review=$('#reviewChanges');showPopup=showDifferencesOption(parseInt(selectedDefault.photobookFormatId),getFormatId(),configuration.formats,review.find('.formatChange'))||showPopup;showPopup=showDifferencesOption(parseInt(selectedDefault.paperQualityId),getPaperId(),configuration.papers,review.find('.paperChange'))||showPopup;showPopup=showDifferencesOption(parseInt(selectedDefault.coverTypeId),getCoverId(),configuration.covers,review.find('.coverChange'))||showPopup;showPopup=showCoverColorDifferencesOption(parseInt(selectedDefault.coverColorId),getCoverColorId(),configuration.coversColor,review.find('.coverColorChange'))||showPopup;showPopup=showDifferencesOption(parseInt(selectedDefault.shippingType),getShippingType(),configuration.shippingType,review.find('.shippingType'))||showPopup;showPopup=checkOptions()||showPopup;if(showPopup){review.modal('show');}
return showPopup;}}
function checkOptions(){var showPopup=false,$reviewChanges=$('#reviewChanges'),coverPaddingContainer=$reviewChanges.find('.coverPaddingChange'),contentFinishContainer=$reviewChanges.find('.contentFinishChange'),endPaperContainer=$reviewChanges.find('.endPaperChange');if($('#padded_cover:visible').length){showPopup=showDifferencesOption(parseInt(selectedDefault.paddedCover),getPaddedCover(),configuration.coverPadding,coverPaddingContainer)||showPopup;}else{coverPaddingContainer.addClass('hide');}
if($('input[name="content_finish"]:visible').length){showPopup=showDifferencesOption(selectedDefault.contentFinish,getContentFinish(),configuration.contentFinish,contentFinishContainer)||showPopup;}else{contentFinishContainer.addClass('hide');}
if($('input[name="end_paper"]:visible').length){showPopup=showDifferencesOption(selectedDefault.endPaper,getEndPaper(),configuration.endPaper,endPaperContainer)||showPopup;}else{endPaperContainer.addClass('hide');}
return showPopup;}
function showCoverColorDifferencesOption(originalValue,changedValue,config,container){var showPopup=false;if((changedValue!=originalValue)&&(changedValue||originalValue)){showPopup=true;var missingValue=false;if(!isNaN(originalValue)&&config[selectedDefault.coverTypeId]&&config[selectedDefault.coverTypeId][originalValue]){container.find('.from').html(config[selectedDefault.coverTypeId][originalValue]);}else{missingValue=true;}
if(!isNaN(changedValue)&&config[getCoverId()]&&config[getCoverId()][changedValue]){container.find('.to').html(config[getCoverId()][changedValue]);}else{missingValue=true;}
if(missingValue){container.addClass('hide');}else{container.removeClass('hide');}}else{container.addClass('hide');}
return showPopup;}
function showDifferencesOption(originalValue,changedValue,config,container){var showPopup=false;if(changedValue!=originalValue){showPopup=true;container.removeClass('hide');container.find('.from').html(config[originalValue]);container.find('.to').html(config[changedValue]);}else{container.addClass('hide');}
return showPopup;}
if(!document.view.flipbook.configuration.doNotOrder){$(window).scroll(checkDifferences);}
function getCostEstimate(){if(configuration.isUnbranded){return false;}
var params={photobook_format_id:(isPremium)?premiumFormatId:getFormatId(),cover_type_id:(isPremium)?premiumCoverTypeId:getCoverId(),paper_quality_id:(isPremium)?premiumQualityId:getPaperId(),jobNumber:jobNumber,padded_cover:(isPremium)?premiumPaddedCover:getPaddedCover(),presentation_box:(isPremium)?premiumPresentationBox:getPresentationBox(),price_region:configuration.regionIso,},estimateElement=$('#costEstimate');estimateElement.fadeOut();$.post(costEstimateUrl,params,function(resp){if(resp){for(var k in resp){var el=estimateElement.find('.'+k);if(el.length){el.html(resp[k]);}}
if(resp.show_editor_price==1){estimateElement.find('.showEditorPrice').removeClass('hide');}else{estimateElement.find('.showEditorPrice').addClass('hide');}
if(resp.show_design_price==1){estimateElement.find('.showDesignPrice').removeClass('hide');}else{estimateElement.find('.showDesignPrice').addClass('hide');}
if(resp.papersPrice&&!isPremium){for(var i in resp.papersPrice){$('.paper-item[data-id="'+resp.papersPrice[i]['paper_quality_id']+'"] .photobookPrice').html(resp.papersPrice[i]['photobook_price']).parent().removeClass('hide');}}
if(resp.pricePerPages&&!isPremium){for(var i in resp.pricePerPages){$('.paper-item[data-id="'+resp.pricePerPages[i]['paper_quality_id']+'"] .pricePerPage').html(resp.pricePerPages[i]['paper_price']).parent().removeClass('hide');}}
if(resp.box_price&&!isPremium){$('#presentation_box_label_text').text(resp.box_price);}
estimateElement.fadeIn().removeClass('hidden');}});}
function getCoverColorId(){var coverColorItem=$('.cover-item.active').find('.coverTypeColorLabel.selected input[type="radio"]');if(coverColorItem.length){return parseInt(coverColorItem.val());}
return 0;}
function getFormatId(){return parseInt($('.format.active').parent('.format-wrapper:first').attr('data-id'));}
function getPaperId(){return parseInt($('.paper-item.active').attr('data-id'));}
function getCoverId(){return parseInt($('.cover-item.active').attr('data-id'));}
function getPaddedCover(){return $('.padded_cover:checked').length;}
function getPresentationBox(){return $('input[name="presentation_box"]:checked').length;}
function getBoxColorId(){return $('#box_color_id').val();}
function getShippingType(){return $('input[name="shipping"]:checked').val();}
function getContentFinish(){return $('input[name="content_finish"]:checked').val();}
function getEndPaper(){return $('input[name="end_paper"]:checked').val();}
function coverSupportsEmbossing(coverId){return coverId==2||coverId==4||coverId==5||coverId==6||coverId==8;}
function coverSupportsPadded(coverId){return coverId==1;}
function checkEndPaperDisplay(){var $endPaperContainer=$('#endPaperContainer');if(getPaperId()>5&&document.view.flipbook.configuration.doNotOrder==0){$endPaperContainer.removeClass('hide');}else{var $endPaperInput=$('input[name="end_paper"]');$endPaperInput.filter(':checked').removeAttr('checked');$endPaperInput.filter('[value="white"]').prop("checked",true);$endPaperInput.trigger('change');$endPaperContainer.addClass('hide');}}
function checkContentFinishDisplay(){if(getPaperId()!=5){$('#contentFinishContainer').addClass('hide');}else{$('#contentFinishContainer').removeClass('hide');}}
function checkSelectedCoverColor(coverColorId){if(coverColorId){var coverColor=$('.covertypecolor[value="'+coverColorId+'"]'),coverType=coverColor.parents('.cover-item:first');if(coverType.hasClass('active')){coverType.find('.coverTypeColorLabel.selected').removeClass('selected');coverColor.parent('.coverTypeColorLabel').addClass('selected');coverType.find('.title').html(coverColor.attr('data-color-name'));coverType.find('.cover-type').attr('class',coverType.find('.cover-type').attr('data-class')+' '+coverColor.attr('data-color'));getCostEstimate();}}}
function checkPaper(checkEstimate){var formatId=getFormatId();$('.paper-item').each(function(){var that=$(this),paperId=parseInt(that.attr('data-id'));if(formats[formatId].paper.indexOf(paperId)!=-1){that.removeClass('hide');}else{that.addClass('hide');}});if($('.active.paper-item').hasClass('hide')){$('.active.paper-item.hide').removeClass('active');$('.paper-item:not(.hide):first').addClass('active');checkEstimate=false;}
if(formatId==1){$('.paper-item[data-id=3],.paper-item[data-id=2]').addClass('hide');}
if($('.paper-item.active.hide').length){$('.paper-item.active.hide').removeClass('active');if($('.paper-item:not(.hide)').length){$('.paper-item:not(.hide)')[0].addClass('active');}}
checkEndPaperDisplay();checkContentFinishDisplay();if(!checkEstimate){getCostEstimate();}}
function changeEndpaper(){var blankPage=$('.pik-blank-page, .booklet .b-page-blank');if($('input[name="end_paper"]:checked').val()=='white'){blankPage.addClass('pik-blank-page-white');}else{blankPage.removeClass('pik-blank-page-white');}}
function updateEndPaper(){var endPaperInput=$('input[name="end_paper"]'),endPaperValue=$('input[name="end_paper"]:checked').val(),endPaperContainer=$('#endPaperContainer'),params={jobNumber:jobNumber,endPaper:endPaperValue};endPaperInput.blur();if(isPremium){endPaperContainer.fadeOut();$.post(config.updateEndPaperUrl,params,function(resp){endPaperContainer.fadeIn().removeClass('hidden');if(resp.success){changeEndpaper();}});}else{changeEndpaper();}}
function reviewChangesCancel(){$('.format.active').removeClass('active');$('.format-wrapper[data-id="'+selectedDefault.photobookFormatId+'"]').find('.format').addClass('active');$('.paper-item.active').removeClass('active');$('.paper-item[data-id="'+selectedDefault.paperQualityId+'"]').addClass('active');$('.cover-item.active').removeClass('active');$('.cover-item[data-id="'+selectedDefault.coverTypeId+'"]').addClass('active');if(selectedDefault.coverColorId){$('.cover-item.active .coverTypeColorLabel.selected').removeClass('selected');$('.covertypecolor[value="'+selectedDefault.coverColorId+'"]').parents('.coverTypeColorLabel:first').addClass('selected');checkSelectedCoverColor(selectedDefault.coverColorId);}
if(parseInt(selectedDefault.presentationBox)){$('#presentation_box').prop("checked",true).val(1);}else{$('#presentation_box').removeAttr('checked').val(0);}
$('input[name="content_finish"]:checked').removeAttr('checked');$('input[name="content_finish"][value="'+selectedDefault.contentFinish+'"]').prop("checked",true);$('input[name="end_paper"]:checked').removeAttr('checked');$('input[name="end_paper"][value="'+selectedDefault.endPaper+'"]').prop("checked",true);$('.format.active,.paper-item.active,.cover-item.active').click();changeEndpaper();checkContentFinishDisplay();checkEndPaperDisplay();$('#reviewChanges').modal('hide');}
function reviewChangesSave(){if(!isPremium){$('#reviewChanges').modal('hide');}
if((!getFormatId()||!getPaperId||!getCoverId())&&(!isPremium)){return;}
var changes=(isPremium)?{job_number:jobNumber,presentation_box:getPresentationBox(),shipping_type:getShippingType()}:{photobook_format:getFormatId(),paper_quality:getPaperId(),cover_type:getCoverId(),cover_color:getCoverColorId(),padded_cover:getPaddedCover(),content_finish:getContentFinish(),end_paper:getEndPaper(),job_number:jobNumber,presentation_box:getPresentationBox(),shipping_type:getShippingType()};$.post(config.updateJobUrl,changes,function(){if(isPremium){selectedDefault.presentationBox=changes.presentation_box;selectedDefault.shippingType=changes.shipping_type;}else{selectedDefault.photobookFormatId=changes.photobook_format;selectedDefault.paperQualityId=changes.paper_quality;selectedDefault.coverTypeId=changes.cover_type;selectedDefault.coverColorId=changes.cover_color;selectedDefault.paddedCover=changes.padded_cover;selectedDefault.contentFinish=changes.content_finish;selectedDefault.endPaper=changes.end_paper;selectedDefault.presentationBox=changes.presentation_box;selectedDefault.shippingType=changes.shipping_type;}});}
function presentationBoxSave(){if(!isPremium){$('#reviewChanges').modal('hide');}
if((!getFormatId()||!getPaperId||!getCoverId())&&(!isPremium)){return;}
var changes={job_number:jobNumber,presentation_box:getPresentationBox()};$.post(config.updateJobUrl,changes,function(){selectedDefault.presentationBox=changes.presentation_box;});}
$(document).on('click','.coverTypeColorLabel',function(e){e.preventDefault();e.stopImmediatePropagation();var that=$(this);$('.cover-item.active').removeClass('active');that.parents('.cover-item').addClass('active');checkSelectedCoverColor(that.find('.covertypecolor').val());});$(document).on('click','.cover-item',function(e){$('.cover-item.active').removeClass('active');$(this).addClass('active');getCostEstimate();});$(document).on('click','.album .btn',function(e){e.preventDefault();var
that=$(this),estimateElement=$('#costEstimate'),boxColors=that.parent().find('.boxColors').children().eq(0),params={photobook_format_id:getFormatId(),cover_type_id:getCoverId(),paper_quality_id:getPaperId(),jobNumber:jobNumber,padded_cover:getPaddedCover(),shipping_type:getShippingType(),box_color_id:getBoxColorId()};params.presentation_box=(that.hasClass('added'))?0:1;estimateElement.fadeOut();$.post(config.updateBoxUrl,params,function(resp){if(that.hasClass('added')){that.removeClass('added').html($.i18n._('ADD_A_BOX'));$('[name="presentation_box"]').prop('checked',false).val(0);boxColors.addClass('hidden');}else{that.addClass('added').html($.i18n._('REMOVE_BOX'));$('[name="presentation_box"]').prop('checked',true).val(1);boxColors.removeClass('hidden');}
for(var k in resp){var el=estimateElement.find('.'+k);if(el.length){el.html(resp[k]);}}
estimateElement.fadeIn().removeClass('hidden');});});$(document).on('change','.album select',function(e){e.preventDefault();var
that=$(this),estimateElement=$('#costEstimate'),boxColors=that.parent().find('.boxColors').children().eq(0),params={photobook_format_id:getFormatId(),cover_type_id:getCoverId(),paper_quality_id:getPaperId(),jobNumber:jobNumber,padded_cover:getPaddedCover(),shipping_type:getShippingType(),box_color_id:getBoxColorId()};params.presentation_box=(that.hasClass('added'))?0:1;estimateElement.fadeOut();$.post(config.updateBoxUrl,params,function(resp){});});$(document).on('click','.form-content .radio input[type="radio"] + span',function(){var
thisRadioInput=$(this).prev(),oldRadioChecked=$('.form-content .radio input[type="radio"]:checked'),estimateElement=$('#costEstimate'),params={photobook_format_id:getFormatId(),cover_type_id:getCoverId(),paper_quality_id:getPaperId(),jobNumber:jobNumber,padded_cover:getPaddedCover(),presentation_box:getPresentationBox(),expedite:thisRadioInput.val()};estimateElement.fadeOut();$.post(document.view.flipbook.configuration.updateShippingUrl,params,function(resp){oldRadioChecked.prop('checked',false);oldRadioChecked.parent().parent().addClass('gray');oldRadioChecked.parent().parent().parent().parent().children().last().addClass('gray');thisRadioInput.prop('checked',true);thisRadioInput.parent().parent().parent().parent().find('.gray').removeClass('gray');for(var k in resp){var el=estimateElement.find('.'+k);if(el.length){el.html(resp[k]);}}
estimateElement.fadeIn().removeClass('hidden');});});$(document).on('change','input[name="padded_cover"]',function(){getCostEstimate();return true;});$(document).on('change','input[name="presentation_box"]',function(){getCostEstimate();return true;});$(document).on('change','input[name="end_paper"]',updateEndPaper);$(document).on('click','#reviewChangesSave',reviewChangesSave);$(document).on('click','#reviewChangesCancel',reviewChangesCancel);$(document).on('change','#presentation_box',presentationBoxSave);var previousFormat=getFormatId();$(document).on('click','.format-wrapper',function(e){e.preventDefault();formatChange($(this));});$(document).on('click','.paper-item img, .paper-item .title, .paper-item .description .text',function(e){e.preventDefault();var that=$(this).parents('.paper-item:first'),formatId=getFormatId();if(that.hasClass('hide')||that.hasClass('active')){return true;}
$(that.children()[0]).removeClass('gray-filter');$($('.paper-item.active').children()[0]).addClass('gray-filter');$('.paper-item.active').removeClass('active');that.addClass('active');var paperId=getPaperId();if((paperId==5)&&(formatId==4)&&(parseInt(configuration.numberOfPages)>parseInt(configuration.largeLayFlatMaxPages))){$('.format1 .format').addClass('disabled');}
if(paperId<5){$('.format1 .format').addClass('disabled');}else{$('.format1 .format').removeClass('disabled');}
checkEndPaperDisplay();checkContentFinishDisplay();getCostEstimate();});checkSelectedCoverColor(parseInt(selectedDefault.coverColorId));checkPaper(true);var options={maxLength:1000,opacity:0.80,dragPadding:10};var $mybook=$('#mybook'),$saving=$('#save-display'),$hint=$('#pik-review-hint').hide(),$book_api=$mybook.data('booklet'),jobID=document.view.flipbook.configuration.jobId,reviewID=document.view.flipbook.configuration.reviewId,isOrderSendable=config.isOrderFlag==1,isEditable=config.notOrder==0,isSaved=true,isUnbranded=document.view.flipbook.configuration.isUnbranded,types={none:0,caption:1,feedback:2},strings={caption:$.i18n._('ENTER_CAPTION'),feedback:$.i18n._('ENTER_FEEDBACK'),saved:$.i18n._('SAVED'),saving:$.i18n._('SAVING'),not_saved:$.i18n._('NOT_SAVED'),unsaved:$.i18n._('NAVIGATION_AWAY_MSG')},templates={caption:'<div class="pik-review pik-review-caption" style="position:absolute; top:0; left:0;">'+'<div class="pik-review-background"><span>'+strings.caption+'</span></div>'+'<textarea class="pik-review-text pik-review-text-form"></textarea>'+'<div class="pik-review-text pik-review-text-static"></div>'+'<a href="#" class="pik-review-delete">x</a>'+'</div>',feedback:'<div class="pik-review pik-review-feedback" style="position:absolute; top:0; left:0;">'+'<div class="pik-review-background"><span>'+strings.feedback+'</span></div>'+'<textarea class="pik-review-text pik-review-text-form"></textarea>'+'<div class="pik-review-text pik-review-text-static"></div>'+'<a href="#" class="pik-review-delete">x</a>'+'</div>',saving:'<div class="pik-review-saving">'+strings.saved+'</div>'};var currentType=types.none;if(isEditable){enableReviews();}else{disableReviews();}
$(document).on('change',"#review_version",function(){var val=$(this).val(),url=config.reviewJobUrl+document.view.flipbook.configuration.jobNumber+"/version/"+val;if(config.fullscreen==1){url+='/fullscreen/true';}
url+=window.location.hash;window.location.href=url;});$('body').on('bookletLoaded',function(){$book_api=$mybook.data('booklet');});$(window).bind('beforeunload',function(e){if(isEditable&&!isSaved){return strings.unsaved;}});$(document).unbind('keydown').bind('keydown',function(event){if(event.keyCode==8){if(event.target.nodeName=='BODY'){event.preventDefault();}}});if($('#header-section-flip-book.sharePage.landscape:not(.fullscreen)').length){function repositionFlipbook(){var space=($('#main-section').height()-$('#header-section').height()-50-$('#body-section-flip-book').height())/2;$('#body-section-flip-book').css('margin-top',space);}
$(window).resize(function(){repositionFlipbook();});repositionFlipbook();}
var order_margin=($('div.order').outerWidth()-$('#ORDER-element').outerWidth())/2;$('#ORDER-element').css({'marginLeft':order_margin});$('.top-link').click(function(){$(this).attr('href',$(this).attr('href')+window.location.hash);});$('#body-section-flip-book').css({padding:'50px 0 0'});$('#add-caption').click(function(e){e.preventDefault();setReviewType(types.caption);});$('#add-feedback').click(function(e){e.preventDefault();setReviewType(types.feedback);});$(document).on('click','#submitReviews',function(){saveFeedback(0);});$(document).on('click','.pik-page',function(e){var template;if(isEditable){if(currentType==types.caption){template=templates.caption;}else if(currentType==types.feedback){template=templates.feedback;}
if(currentType!=types.none&&typeof template!='undefined'){var x=e.pageX-$(this).offset().left;var y=e.pageY-$(this).offset().top;if(x>$(this).width()-204)
x=$(this).width()-204;if(y>$(this).height()-104)
y=$(this).height()-104;var review=$(template).css({left:x,top:y});review.appendTo($(this));review.find('.pik-review-text-form').show().focusAtEnd();review.find('.pik-review-text-static').hide();toggleEditing(review);enableReviews();}}
$hint.hide();currentType=types.none;});$(document).on('click','.pik-review-text-static',function(){if(isEditable){$(this).hide();$(this).siblings('.pik-review-text-form').show().css({'display':'block'}).focusAtEnd();toggleEditing($(this).parent());}});$(document).on('blur','.pik-review-text-form',function(){if(isEditable){var text=$(this).val();if(text==''||text==strings.caption||text==strings.feedback){$(this).parent().remove();}else{$(this).hide().siblings('.pik-review-text-static').html(text.replace(/\n/g,"<br />")).show()
[0].scrollTop=this.scrollTop;toggleEditing($(this).parent());}
saveFeedback(1,$(this).parents('.pik-review:first'));}}).on('keydown keyup','.pik-review-text-form',function(){var text=$(this).val();if(text.length>options.maxLength){$(this).val(text.slice(0,options.maxLength));}
if(text.length==0){var placeholder=$(this).parent().hasClass('pik-review-caption')?strings.caption:strings.feedback;$(this).siblings('.pik-review-background').find('span').text(placeholder);}else{$(this).siblings('.pik-review-background').find('span').text('');}});$('body').on('click','.pik-review-delete',function(e){e.preventDefault();$(this).siblings().remove();$(this).parent().remove();saveFeedback();if(getReviewNumber()==0){$saving.slideUp();}});$('#fullscreen-button').on('click',function(e){e.preventDefault();var params=['height='+screen.height,'width='+screen.width,'fullscreen=yes'].join(',');var popup=window.open(config.fullscreenReviewUrl,'popup_window',params);popup.moveTo(0,0);});function showSavingText($element){if(!$element.length){return;}
var savingWidth=90,savingHeight=25,x=($element.width()-savingWidth)/2,y=($element.height()-savingHeight)/2,$saving=$(templates.saving).css({left:x,top:y});$element.append($saving);$saving.fadeIn('slow');setTimeout(function(){$saving.fadeOut('slow',function(){$saving.remove();})},1000);}
function toggleEditing(el){el.toggleClass('pik-review-editing');}
function setReviewType(newType){if(!$mybook.is(':hidden')&&isEditable){$hint.show();currentType=newType;}else if(!isEditable){$('#errorEdit').modal('show');}}
function firstLetterUp(string){return string.charAt(0).toUpperCase()+string.slice(1);}
function enableReviews(){$('.pik-review').each(function(){$(this).draggable({containment:'.booklet',handle:".pik-review-background",drag:function(event,ui){ieUpdateHeights($(this));var that=$(this),x=ui.position.left,w=$(this).outerWidth(),page=that.parents('.b-page'),pageW=that.parent().width(),isLeft=that.parents('.b-wrap').hasClass('b-wrap-left');if(x+w>=pageW+(w/2)){var rightPage=page.next().find('.pik-page');if(rightPage.length>0&&!that.hasClass('onDrag')){that.addClass('onDrag').detach().appendTo(rightPage);enableReviews();that.removeClass('onDrag').css('left',0);}
return false;}else if(x<=-(w/2)&&!isLeft){var leftPage=page.prev().find('.pik-page');if(leftPage.length>0&&!that.hasClass('onDrag')){that.addClass('onDrag').detach().appendTo(leftPage);enableReviews();that.removeClass('onDrag').css('left',pageW-w);}
return false;}},stop:function(event,ui){showSavingText($(this));saveFeedback();}}).resizable({containment:'parent',minHeight:18,minWidth:50,handles:'se',resize:function(event,ui){ieUpdateHeights($(this));},stop:function(event,ui){saveFeedback();}});$('.pik-review-background').css({'opacity':options.opacity,'filter':'progid:DXImageTransform.Microsoft.Alpha(opacity='+(100*options.opacity)+')'});ieUpdateHeights($(this));});}
function ieUpdateHeights(review){var h=review.outerHeight()-parseInt(review.css('borderTopWidth'))-parseInt(review.css('borderBottomWidth'));var w=review.outerWidth()-parseInt(review.css('borderLeftWidth'))-parseInt(review.css('borderRightWidth'));review.find('.pik-review-background').css({'height':h,'width':w});review.find('.pik-review-text-form, .pik-review-text-static').css({'height':h-(options.dragPadding*2),'width':w-(options.dragPadding*2),'margin':options.dragPadding});}
function disableReviews(){$('.pik-review').addClass('pik-review-disabled');$('.pik-review-delete, .pik-review-text-form').remove();$('.pik-review-text-static, .pik-review-background').css({cursor:'default'});}
$('#save-button').click(function(e){e.preventDefault();saveFeedback();});$('#send-button').click(function(e){e.preventDefault();if(!checkDifferences(true)){if(getReviewNumber()==0){$('#errorNoReviews').modal('show');return;}
$('#submitReview').modal('show');}});$('#designConfirmation').on('show.bs.modal',function(){var $modal=$(this),bookType,formatId=getFormatId(),paperId=getPaperId(),coverId=getCoverId(),coverColorId=getCoverColorId(),coverName,paperName=config.papers[paperId],presentationBox=$.i18n._('No'),hasPresentationBox=$('input[name="presentation_box"]:checked').length,presentationBoxColor=$('select#box_color_id').length?$('select#box_color_id option:selected').html():'',paddedCover=config.isPremium?config.selectedDefault.paddedCover:getPaddedCover();if(getPaperId()==5){bookType='layflatBook'}else if(config.isPremium){bookType='premiumBook'}else{bookType='photoBook';}
if(bookType=='photoBook'){$modal.find('span.notLayflat').removeClass('hidden');}else{$modal.find('span.notLayflat').addClass('hidden');}
if(config.isPremium){coverName=config.premiumCover;}else{if(coverColorId){coverName=config.coversColor[coverId][coverColorId];}else{coverName=config.covers[coverId];}}
if(config.embossingColor&&coverSupportsEmbossing(coverId)){coverName+=', '+$.i18n._('EMBOSSING')+': '+$.i18n._(config.embossingColor);}
if(paddedCover&&coverSupportsPadded(coverId)){coverName+=' '+$.i18n._('Padded')}
if(bookType=='layflatBook'||bookType=='premiumBook'){var contentFinish;if(getContentFinish()){contentFinish=config.contentFinish[getContentFinish()];}else{contentFinish=config.selectedContentFinish;}
paperName+=' '+firstLetterUp(contentFinish);}
if(hasPresentationBox){presentationBox=$.i18n._('Yes');if(config.isPremium){presentationBox+=' - '+presentationBoxColor;}}
$modal.find('.confirmation').addClass('hidden');$modal.find('.confirmation.'+bookType).removeClass('hidden');$modal.find('span.coverType').html(coverName);$modal.find('span.paperType').html(paperName);$modal.find('span.format').html(config.formats[formatId]+' ('+config.formatSizes[formatId]+')');$modal.find('span.withPresentationBox').html(presentationBox);});$('#proceedToCart').click(function(){$('#review').submit();});$('#ORDER').click(function(){if(!checkDifferences(true)){if(!config.isUnbranded){if(checkOrder()){$('#designConfirmation').modal('show');}
return false;}else{return checkOrder();}}
return false;});$('#REORDER').click(function(){return checkOrder();});$(document).on('click','#errorOrderAddToCart',function(){$('#send_order').trigger('click');});$(document).on('click','#orderDetails',function(e){e.preventDefault();$('html, body').animate({scrollTop:$('.formats.wrapper').offset().top},500);});$(document).on('click','.backToReview',function(e){e.preventDefault();$('html, body').animate({scrollTop:$('body').offset().top},500);});if($('#costEstimate').length){if(!isPremium){$(window).scroll(function(){if($(window).scrollTop()>$('.formats.wrapper').offset().top){$('#costEstimate').addClass('fixed');}else{$('#costEstimate').removeClass('fixed');}});}}
function saveFeedback(isAjax,$el){isAjax=typeof isAjax=='undefined'?1:isAjax;if(!isEditable){$('#errorEdit').modal('show');return false;}
var json=getJSON(isAjax),myObject=eval('('+json+')');$.ajax({url:config.feedbackUrl,dataType:'html',data:myObject,type:'post',success:function(){if(!isAjax){if(!isUnbranded){window.location.href=config.userOrderUrl;}else{window.location.href=config.unbrandedReviewUrl;}}
if($el){showSavingText($el);}},error:function(){$('#errorFail').modal('show').on('hidden.bs.modal',function(){window.location.reload();});}});}
function checkOrder(){if(!isEditable){$('#errorEdit').modal('show');return false;}
if(getReviewNumber()>0){$('#errorReviewsNotSent').modal('show');return false;}
if(!isOrderSendable){$('#errorOrder').modal('show');return false;}
return true;}
String.prototype.escapeSpecialChars=function(){return this.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\f/g,"\\f").replace(/"/g,"\\\"").replace(/'/g,"\\\'").replace(/\&/g,"\\&");};function getJSON(isAjax){var finished=isAjax==1?0:1;var review_count=0;var json='{';json+='"reviewID":"'+reviewID+'",';json+='"jobID":"'+jobID+'",';json+='"finished":'+finished+',';json+='"isUnbranded":'+isUnbranded+',';json+='"reviews":[';$('.pik-review').each(function(i){var text=$(this).find('textarea').val();if(text!=''&&text!=strings.caption&&text!=strings.feedback){json+='{';json+='"type":"'+($(this).hasClass('pik-review-caption')?'C':'F')+'",';json+='"text":"'+text.escapeSpecialChars()+'",';json+='"page":'+getPageNumber($(this).parents('.b-page'))+',';json+='"top":'+parseInt($(this).css('top'))/ratioX+',';json+='"left":'+parseInt($(this).css('left'))/ratioY+',';json+='"width":'+parseInt($(this).css('width'))+',';json+='"height":'+parseInt($(this).css('height'));json+='},';review_count++;}});if(review_count>0){json=json.slice(0,json.length-1);}
json+=']}';return json;}
function getPageNumber(page){for(i=0;i<$mybook.find('.b-page').length;i++){if(page.hasClass('b-page-'+i)){return i;}}}
function getReviewNumber(){var review_count=0;$('.pik-review').each(function(i){var text=$(this).find('textarea').val();if(text!=''&&text!=strings.caption&&text!=strings.feedback){review_count++;}});return review_count;}
function formatChange(elem){var that=$(elem);if(that.find('.format.disabled').length){return true;}
$('.format.active').removeClass('active');that.find('.format').addClass('active');if([1,2,4,5].indexOf(getFormatId())!=-1){$('.presentationBox').removeClass('hide');}else{$('.presentationBox').addClass('hide');$('input#presentation_box').removeAttr('checked');}
if([4,5].indexOf(getFormatId())!=-1&&[1,2,3].indexOf(previousFormat)!=-1){if(getPaperId()!=5){$('.active.paper-item').removeClass('active');$('.paper-item[data-id="2"]').addClass('active');}}
checkPaper();if([1].indexOf(getFormatId())!=-1&&(parseInt(configuration.numberOfPages)>parseInt(configuration.largeLayFlatMaxPages))){$('.paper-item[data-id="5"]').addClass('hide');}
previousFormat=getFormatId();}
$(document).ready(function(){if(!document.view.flipbook.configuration.doNotOrder){getCostEstimate();formatChange($('.format.active').parent());}
$(document).on('click','#downloadPageDetails',function(){$('#imageCorrectionPopup #downloadPageDetails, #imageCorrectionPopup .textToDisplay').addClass('hidden');$('#imageCorrectionPopup #closeModalButton, #imageCorrectionPopup .textAfterClick').removeClass('hidden');});if(!configuration.isUnbranded&&!PikMobileWarning.isMobile()&&$('#imageCorrectionPopup').length){$('#imageCorrectionPopup').modal('show');}});});
PikMobileWarning=function(){isMobile=function(){var isAndroid=function(){return navigator.userAgent.match(/Android/i);},isBlackBerry=function(){return navigator.userAgent.match(/BlackBerry/i);},isiOS=function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i);},isOpera=function(){return navigator.userAgent.match(/Opera Mini/i);},isWindows=function(){return navigator.userAgent.match(/IEMobile/i);};return(isAndroid()||isBlackBerry()||isiOS()||isOpera()||isWindows())&&($(window).width()<768);};function init(){if(isMobile()){$('#mobileWarningPopup').modal('show');}}
return{init:init,isMobile:isMobile}}();